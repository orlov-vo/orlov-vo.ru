<!DOCTYPE html>
<html lang="ru-RU">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
        
        <title>Заметки про Serverless - часть 1 - Vladislav Orlov - orlov-vo.ru</title>
        
        <link rel="shortcut icon" href="/favicon.png" />
        <link href="/main.1a9f2.css" rel="stylesheet" />
        
        
    </head>

    <body>
<header class="l-container l-header">
    <a href="/" class="invisible-link">
        <picture>
            <source srcset="/profile-pic.avif" type="image/avif" />
            <img class="l-header__avatar" src="/profile-pic.jpg" alt="Vladislav Orlov" />
        </picture>

        <author class="l-header__author">Vladislav Orlov </author>
    </a>

    <p class="l-header__description">
        Цифровой-кочевник и JS/TS разработчик
    </p>

    <nav class="l-header__nav">
          
        <a href="https://twitter.com/orlov_vo" target="_blank">Twitter</a>
           ‧ 
        <a href="https://github.com/orlov-vo" target="_blank">GitHub</a>
           ‧ 
        <a href="https://instagram.com/orlov_vo/" target="_blank">Instagram</a>
           ‧ 
        <a href="https://t.me/orlov_vo" target="_blank">Telegram</a>
         
    </nav>
</header>

<div id="content">
  <article class="l-container b-post">
    
    <header class="b-post__header">
        <h1 class="b-post__title">Заметки про Serverless - часть 1</h1>

        
        
        <time class="b-post__date" datetime=" 2019-04-04T00:00:00Z ">
            4 апреля
            2019
        </time>
        

        
        <span class="b-post__duration">5 мин. чтения</span>
        

        
    </header>
    

    







    <a class="invisible-link" href="/2019/serverless-part-1/cloud.jpg">
        <img
            srcset="/2019/serverless-part-1/cloud_hu872858233376344022245f1c27afe756_2308329_440x0_resize_q80_box.jpg 480w,
                    /2019/serverless-part-1/cloud_hu872858233376344022245f1c27afe756_2308329_870x0_resize_q80_box.jpg 870w"
            sizes="(max-width: 480px) 440px,
                   870px"
            src="/2019/serverless-part-1/cloud_hu872858233376344022245f1c27afe756_2308329_870x0_resize_q80_box.jpg"
            alt=""
        />
    </a>

    

<p>Решил написать небольшие заметки по построению простого REST API в качестве Serverless решения.</p>
<p>Serverless - это способ запуска веб-приложения в вакууме. Главным преимуществом такого запуска
является легкость горизонтального масштабирования при увеличении нагрузок с тарификацией за
использованные ресурсы.</p>
<p>Идеальным кейсом для использования Serverless является ситуация, когда вы создаете сервис, который
неизвестно как будет расти (возможно запросов в сутки будет небольшое количество). Такой подход
позволит снизить расходы на поднятие серверов, которые большую часть будут простаивать.</p>
<p>Технологию Serverless предлагают большинство облачных провайдеров: AWS Lambda, Azure Functions,
Google Cloud Functions, Kubeless, Cloudflare Workers, Netlify Functions. По большей части они
являются схожими в принципах работы, но различия кроются в деталях.</p>
<p>Для того, чтобы не иметь сильной привязки к провайдеру рекомендуется использовать более абстрактные
решения, например Serverless Framework. Вот о нем я хочу и рассказать.</p>
<h2 id="привет-мир-на-serverless-framework">Привет мир на Serverless Framework</h2>
<p>Любая технология требует ознакомления, поэтому начнем наше знакомство от простого к сложному.</p>
<p>Создаем новый проект и устанавливаем необходимые зависимости из npm:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">mkdir ./serverless-hello-world <span style="color:#f92672">&amp;&amp;</span> cd ./serverless-hello-world
npm init -y
npm install --save express serverless-http
npm intsall --save-dev serverless-offline
</code></pre></div><p>После выполнения этих команд у нас создалась директория <code>serverless-hello-world</code> в которой был
инициализирован новый проект и установлены зависимости из npm.</p>
<p>Теперь создаем <code>index.js</code> файл с таким содержанием:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">express</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;express&#39;</span>);
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">serverless</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;serverless-http&#39;</span>);
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">app</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">express</span>();

<span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;/&#39;</span>, <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) {
    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">send</span>(<span style="color:#e6db74">&#39;Hello World!&#39;</span>);
});

<span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">handler</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">serverless</span>(<span style="color:#a6e22e">app</span>);
</code></pre></div><p>Важно обратить внимание, что по факту мы создаем обычное express приложение. Но вместо запуска его
мы передаем в <code>serverless-http</code> для получения обработчика, который экспортируем.</p>
<p>Теперь когда обработчик готов нужно описывать конфигурацию <code>serverless.yml</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">service</span>: <span style="color:#ae81ff">hello-world</span>

<span style="color:#f92672">plugins</span>:
    - <span style="color:#ae81ff">serverless-offline</span>

<span style="color:#f92672">provider</span>:
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">aws</span>
    <span style="color:#f92672">runtime</span>: <span style="color:#ae81ff">nodejs8.10</span>
    <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">dev</span>
    <span style="color:#f92672">region</span>: <span style="color:#ae81ff">eu-central-1</span>

<span style="color:#f92672">functions</span>:
    <span style="color:#f92672">app</span>:
        <span style="color:#f92672">handler</span>: <span style="color:#ae81ff">index.handler</span>
        <span style="color:#f92672">events</span>:
            - <span style="color:#f92672">http</span>: <span style="color:#ae81ff">ANY /</span>
            - <span style="color:#f92672">http</span>: <span style="color:#e6db74">&#39;ANY {proxy+}&#39;</span>
</code></pre></div><p>Здесь указывается плагин <code>serverless-offline</code>, для тестирования и отладки облачных функций на
локальном компьютере. Следом идут настройки для провайдера, в моем случае это AWS. В последней
секции перечисляются инстансы облачных функций, используемые обработчики и события, которые будут
обрабатывать эти обработчики.</p>
<p>Чтобы протестировать это локально, устанавливаем Serverless CLI и запускаем:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">npm install -g serverless
sls offline start
</code></pre></div><p>Эмулятор запустится на http://localhost:3000</p>
<h2 id="публикация-в-amazon-web-services">Публикация в Amazon Web Services</h2>
<p>Чтобы отправить облачную функцию провайдеру, необходимо авторизоваться / зарегистрироваться в AWS и
выполнить следующие шаги в Консоли AWS:</p>
<ol>
<li>В главном меню сверху ищем в сервисах <em>IAM</em> и переходим в него</li>
<li>В меню слева выбираем пункт <em>Users</em> и начинаем создавать нового пользователя, нажав кнопку <em>Add
user</em>. В форме создания юзера указываем название пользователя, например <code>sls-agent</code>. Дальше
ставим галочку напротив <em>Programmistic access</em> и переходим на следующую страницу.</li>
<li>На странице выбора прав, выбираем вкладку <em>Attach existing policies directly</em> и нажимаем кнопку
<em>Create policy</em>.</li>
<li>В открывшейся новой вкладке выбираем режим представления <em>JSON</em> вместо <em>Visual Editor</em> и внутрь
текстового поля вставляем следующее содержимое из
<a href="https://gist.github.com/ServerlessBot/7618156b8671840a539f405dea2704c8">этого gist</a>. Нажимаем
кнопку <em>Review policy</em>, указываем имя <code>Serverless</code> и создаем политику кнопкой <em>Create policy</em>.</li>
<li>Закрываем вкладку и возвращаемся к прошлой странице, где необходимо выбрать политики для
пользователя. На этой странице мы нажимаем кнопку обновления данных (над таблицей справа) и в
фильтре вводим название созданной политики: <code>Serverless</code>. Ставим галочку напротив найденной
политики и переходим в следующий раздел кнопкой <em>Next: Tags</em></li>
<li>Оставляем все пустым и переходим далее кнопкой <em>Next: Review</em>. Ознакомившись с данными
пользователя, нажимаем <em>Create user</em>.</li>
<li>Копируем к себе <em>Access key ID</em> и <em>Secret access key</em> и завершаем работу с Консолью AWS.</li>
</ol>
<p>Дальше открываем терминал и изменим настройки по умолчанию для Serverless:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sls config credentials --provider aws --key YOUR_ACCESS_KEY_ID --secret YOUR_SECRET_ACCESS_KEY
</code></pre></div><p>Мы настроили профиль по-умолчанию, а для более сложной настройки советую посмотреть
<a href="https://serverless.com/framework/docs/providers/aws/guide/credentials/">документацию</a>. Из простых
вариантов рекомендую использовать переменные окружения <code>AWS_ACCESS_KEY_ID</code> и
<code>AWS_SECRET_ACCESS_KEY</code>.</p>
<p>После авторизации, вы можете публиковать свои облачные функции в AWS:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sls deploy -v
</code></pre></div><p>Поздравляю! Ваша облачная функция теперь в облаке, а адрес по которому она доступна выведен вам в
терминал. В следующих частях будем изучать работу с базой данных.</p>


    
    <footer class="b-post__footer">
        <a href="/posts/">Смотреть другие записи в блоге...</a>
    </footer>
    
</article>


<section class="l-container">
    <div class="b-feedback">
        <p class="b-feedback__description">Оставить отзыв или задать вопрос лично по email</p>

        <form
            class="b-feedback__form"
            enctype="text/plain"
            method="post"
            action="mailto:feedback@orlov-vo.ru"
        >
            <label class="b-feedback__field">
                Имя: <input class="b-feedback__control" type="text" name="name" />
            </label>
            <label class="b-feedback__field">
                Текст:
                <textarea class="b-feedback__control" rows="5" cols="30" name="message"></textarea>
            </label>
            <button class="b-feedback__submit" type="submit">Отправить</button>
        </form>
    </div>
</section>


</div><footer class="l-container l-footer">
    © 2017-2021 Все права защищены, Владислав Орлов.
    <a href="https://github.com/orlov-vo/orlov-vo.ru" target="_blank">Исходники на GitHub</a>
</footer>
<script src="/main.f6ec7.js" defer></script>
        

        
        <script type="text/javascript">
            !function(f,z){f.fz||(f.FintezaCoreObject=z,f.fz=f.fz||function(){(f.fz.q=f.fz.q||[]).push(arguments)},f.fz.l=1*new Date)}
            (window,"fz");
            fz("register","website","vfynzocmswvnmnfqcvajmpfwyolvwgfhaq");
        </script>
        

        <script src="https://content.finteza.com/core.js" defer async></script>
        <noscript>
            <img
                src="https://content.finteza.com/tr?event=Visit&id=vfynzocmswvnmnfqcvajmpfwyolvwgfhaq&ref=https%3a%2f%2forlov-vo.ru%2f2019%2fserverless-part-1%2f&title=%d0%97%d0%b0%d0%bc%d0%b5%d1%82%d0%ba%d0%b8%20%d0%bf%d1%80%d0%be%20Serverless%20-%20%d1%87%d0%b0%d1%81%d1%82%d1%8c%201"
                style="position:absolute; left:-9999px;"
                alt=""
            />
        </noscript>
    </body>
</html>
