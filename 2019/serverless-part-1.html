<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="utf-8" />
        <link rel="shortcut icon" href="/favicon.png" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta http-equiv="content-security-policy" content=""><title>Заметки про Serverless - часть 1 - Vladislav Orlov - orlov-vo.ru</title><link rel="stylesheet" href="/normalize.css" data-svelte="svelte-zz9ekq"><link rel="stylesheet" href="/variables.css" data-svelte="svelte-zz9ekq"><link rel="stylesheet" href="/typography.css" data-svelte="svelte-zz9ekq"><link rel="stylesheet" href="/layout.css" data-svelte="svelte-zz9ekq"><link rel="stylesheet" href="/blocks/post-list-short.css" data-svelte="svelte-zz9ekq"><link rel="stylesheet" href="/blocks/post.css" data-svelte="svelte-zz9ekq"><link rel="stylesheet" href="/blocks/feedback.css" data-svelte="svelte-zz9ekq"><meta property="og:title" content="Заметки про Serverless - часть 1" data-svelte="svelte-1obu40o">
	<link rel="modulepreload" href="/_app/immutable/start-710bce5f.js">
	<link rel="modulepreload" href="/_app/immutable/chunks/index-7f56c5fc.js">
	<link rel="modulepreload" href="/_app/immutable/pages/__layout.svelte-54606ca2.js">
	<link rel="modulepreload" href="/_app/immutable/pages/_...path_.svelte-3e1e7864.js">
	<link rel="modulepreload" href="/_app/immutable/chunks/posts-11342c20.js">
	<link rel="modulepreload" href="/_app/immutable/chunks/PageHeader-c31241fe.js">
    </head>
    <body>
        <div>






<header class="l-container l-header"><a href="/" class="invisible-link"><picture><source srcset="/profile-pic.avif" type="image/avif">
            <img class="l-header__avatar" src="/profile-pic.jpg" alt="Vladislav Orlov"></picture>

        <author class="l-header__author">Vladislav Orlov</author></a>

    <div class="l-header__description">Цифровой-кочевник и JS/TS разработчик</div>

    <nav class="l-header__nav">
            <a href="https://twitter.com/orlov_vo" target="_blank">Twitter</a> ‧ 
            <a href="https://github.com/orlov-vo" target="_blank">GitHub</a> ‧ 
            <a href="https://instagram.com/orlov_vo/" target="_blank">Instagram</a> ‧ 
            <a href="https://t.me/orlov_vo" target="_blank">Telegram</a></nav></header>

<article class="l-container b-post"><header class="b-post__header"><h1 class="b-post__title">Заметки про Serverless - часть 1</h1>

        <time class="b-post__date" datetime="2019-04-04T00:00:00.000Z">04.04.2019</time>

        <span class="b-post__duration">6 мин. чтения</span></header>
    <p><img src="/images/2019/cloud.jpg" alt="Serverless in the Clouds"></p>
<p>Решил написать небольшие заметки по построению простого REST API в качестве Serverless решения.</p>
<p>Serverless - это способ запуска веб-приложения в вакууме. Главным преимуществом такого запуска
является легкость горизонтального масштабирования при увеличении нагрузок с тарификацией за
использованные ресурсы.</p>
<p>Идеальным кейсом для использования Serverless является ситуация, когда вы создаете сервис, который
неизвестно как будет расти (возможно запросов в сутки будет небольшое количество). Такой подход
позволит снизить расходы на поднятие серверов, которые большую часть будут простаивать.</p>
<p>Технологию Serverless предлагают большинство облачных провайдеров: AWS Lambda, Azure Functions,
Google Cloud Functions, Kubeless, Cloudflare Workers, Netlify Functions. По большей части они
являются схожими в принципах работы, но различия кроются в деталях.</p>
<p>Для того, чтобы не иметь сильной привязки к провайдеру рекомендуется использовать более абстрактные
решения, например Serverless Framework. Вот о нем я хочу и рассказать.</p>
<h2>Привет мир на Serverless Framework</h2>
<p>Любая технология требует ознакомления, поэтому начнем наше знакомство от простого к сложному.</p>
<p>Создаем новый проект и устанавливаем необходимые зависимости из npm:</p>
<pre class="language-sh"><!-- HTML_TAG_START --><code class="language-sh">mkdir ./serverless-hello-world &amp;&amp; cd ./serverless-hello-world
npm init -y
npm install --save express serverless-http
npm intsall --save-dev serverless-offline</code><!-- HTML_TAG_END --></pre>
<p>После выполнения этих команд у нас создалась директория <code>serverless-hello-world</code> в которой был
инициализирован новый проект и установлены зависимости из npm.</p>
<p>Теперь создаем <code>index.js</code> файл с таким содержанием:</p>
<pre class="language-js"><!-- HTML_TAG_START --><code class="language-js"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> serverless <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'serverless-http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Hello World!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span>handler <span class="token operator">=</span> <span class="token function">serverless</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre>
<p>Важно обратить внимание, что по факту мы создаем обычное express приложение. Но вместо запуска его
мы передаем в <code>serverless-http</code> для получения обработчика, который экспортируем.</p>
<p>Теперь когда обработчик готов нужно описывать конфигурацию <code>serverless.yml</code>:</p>
<pre class="language-yml"><!-- HTML_TAG_START --><code class="language-yml"><span class="token key atrule">service</span><span class="token punctuation">:</span> hello<span class="token punctuation">-</span>world

<span class="token key atrule">plugins</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> serverless<span class="token punctuation">-</span>offline

<span class="token key atrule">provider</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> aws
    <span class="token key atrule">runtime</span><span class="token punctuation">:</span> nodejs8.10
    <span class="token key atrule">stage</span><span class="token punctuation">:</span> dev
    <span class="token key atrule">region</span><span class="token punctuation">:</span> eu<span class="token punctuation">-</span>central<span class="token punctuation">-</span><span class="token number">1</span>

<span class="token key atrule">functions</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span>
        <span class="token key atrule">handler</span><span class="token punctuation">:</span> index.handler
        <span class="token key atrule">events</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">http</span><span class="token punctuation">:</span> ANY /
            <span class="token punctuation">-</span> <span class="token key atrule">http</span><span class="token punctuation">:</span> <span class="token string">'ANY &#123;proxy+&#125;'</span></code><!-- HTML_TAG_END --></pre>
<p>Здесь указывается плагин <code>serverless-offline</code>, для тестирования и отладки облачных функций на
локальном компьютере. Следом идут настройки для провайдера, в моем случае это AWS. В последней
секции перечисляются инстансы облачных функций, используемые обработчики и события, которые будут
обрабатывать эти обработчики.</p>
<p>Чтобы протестировать это локально, устанавливаем Serverless CLI и запускаем:</p>
<pre class="language-sh"><!-- HTML_TAG_START --><code class="language-sh">npm install -g serverless
sls offline start</code><!-- HTML_TAG_END --></pre>
<p>Эмулятор запустится на http://localhost:3000</p>
<h2>Публикация в Amazon Web Services</h2>
<p>Чтобы отправить облачную функцию провайдеру, необходимо авторизоваться / зарегистрироваться в AWS и
выполнить следующие шаги в Консоли AWS:</p>
<ol><li>В главном меню сверху ищем в сервисах <em>IAM</em> и переходим в него</li>
<li>В меню слева выбираем пункт <em>Users</em> и начинаем создавать нового пользователя, нажав кнопку <em>Add
user</em>. В форме создания юзера указываем название пользователя, например <code>sls-agent</code>. Дальше
ставим галочку напротив <em>Programmistic access</em> и переходим на следующую страницу.</li>
<li>На странице выбора прав, выбираем вкладку <em>Attach existing policies directly</em> и нажимаем кнопку
<em>Create policy</em>.</li>
<li>В открывшейся новой вкладке выбираем режим представления <em>JSON</em> вместо <em>Visual Editor</em> и внутрь
текстового поля вставляем следующее содержимое из
<a href="https://gist.github.com/ServerlessBot/7618156b8671840a539f405dea2704c8" rel="nofollow">этого gist</a>. Нажимаем
кнопку <em>Review policy</em>, указываем имя <code>Serverless</code> и создаем политику кнопкой <em>Create policy</em>.</li>
<li>Закрываем вкладку и возвращаемся к прошлой странице, где необходимо выбрать политики для
пользователя. На этой странице мы нажимаем кнопку обновления данных (над таблицей справа) и в
фильтре вводим название созданной политики: <code>Serverless</code>. Ставим галочку напротив найденной
политики и переходим в следующий раздел кнопкой <em>Next: Tags</em></li>
<li>Оставляем все пустым и переходим далее кнопкой <em>Next: Review</em>. Ознакомившись с данными
пользователя, нажимаем <em>Create user</em>.</li>
<li>Копируем к себе <em>Access key ID</em> и <em>Secret access key</em> и завершаем работу с Консолью AWS.</li></ol>
<p>Дальше открываем терминал и изменим настройки по умолчанию для Serverless:</p>
<pre class="language-sh"><!-- HTML_TAG_START --><code class="language-sh">sls config credentials --provider aws --key YOUR_ACCESS_KEY_ID --secret YOUR_SECRET_ACCESS_KEY</code><!-- HTML_TAG_END --></pre>
<p>Мы настроили профиль по-умолчанию, а для более сложной настройки советую посмотреть
<a href="https://serverless.com/framework/docs/providers/aws/guide/credentials/" rel="nofollow">документацию</a>. Из простых
вариантов рекомендую использовать переменные окружения <code>AWS_ACCESS_KEY_ID</code> и
<code>AWS_SECRET_ACCESS_KEY</code>.</p>
<p>После авторизации, вы можете публиковать свои облачные функции в AWS:</p>
<pre class="language-sh"><!-- HTML_TAG_START --><code class="language-sh">sls deploy -v</code><!-- HTML_TAG_END --></pre>
<p>Поздравляю! Ваша облачная функция теперь в облаке, а адрес по которому она доступна выведен вам в
терминал. В следующих частях будем изучать работу с базой данных.</p>

    <footer class="b-post__footer"><a href="/posts/">Смотреть другие записи в блоге...</a></footer></article>

<section class="l-container"><div class="b-feedback"><div class="b-feedback__description">Оставить отзыв или задать вопрос лично по email</div>

        <form class="b-feedback__form" enctype="text/plain" method="post" action="mailto:feedback@orlov-vo.ru"><label class="b-feedback__field">Имя: <input class="b-feedback__control" type="text" name="name"></label>
            <label class="b-feedback__field">Текст:
                <textarea class="b-feedback__control" rows="5" cols="30" name="message"></textarea></label>
            <button class="b-feedback__submit" type="submit">Отправить</button></form></div></section>

<footer class="l-container l-footer">© 2017-2022 Все права защищены, Владислав Орлов.
    <a href="https://github.com/orlov-vo/orlov-vo.ru" target="_blank">Исходники на GitHub</a></footer>


		<script type="module" data-sveltekit-hydrate="ila8la">
		import { start } from "/_app/immutable/start-710bce5f.js";
		start({
			target: document.querySelector('[data-sveltekit-hydrate="ila8la"]').parentNode,
			paths: {"base":"","assets":""},
			session: {},
			route: true,
			spa: false,
			trailing_slash: "never",
			hydrate: {
				status: 200,
				error: null,
				nodes: [0, 2],
				params: {path:"2019\u002Fserverless-part-1"},
				routeId: "[...path]"
			}
		});
	</script></div>

        <!-- prettier-ignore -->
        <script type="text/javascript">
            !function(f,z){f.fz||(f.FintezaCoreObject=z,f.fz=f.fz||function(){(f.fz.q=f.fz.q||[]).push(arguments)},f.fz.l=1*new Date)}
            (window,"fz");
            fz("register","website","vfynzocmswvnmnfqcvajmpfwyolvwgfhaq");
        </script>
        <!-- prettier-ignore -->

        <script src="https://content.finteza.com/core.js" defer async></script>
    </body>
</html>
